set directories ubuntu-hirsute/

set $fake_size = 0xff0

# breakpoint 1: msg_msg allocation
# b *load_msg+65
b ipc/msgutil.c:54 
commands
    silent
    # printf "msg_msg allocated at address %p\n", $rax
    printf "msg_msg allocated at address %p\n", msg 
    python gdb.execute('continue') # to avoid strange issue, see https://github.com/pwndbg/pwndbg/issues/425
end

# breakpoint 2: ctx->legacy_params allocation
b fs/fs_context.c:542
commands
    silent
    printf "[ ATTENTION ] ctx->legacy_params allocated at address %p\n",$rax
    python gdb.execute('continue') # to avoid strange issue, see https://github.com/pwndbg/pwndbg/issues/425
end

# breakpoint 3: overflow payload passed to fsconfig
b *legacy_parse_param
condition 3 *(unsigned int *)(param->string+23) == $fake_size

# breakpoint 4: sending msg_msg
b ipc/msg.c:1137
commands
    silent
    printf "sending msg_msg allocated at address %p. m_ts is: 0x%x\n", msg, (*msg).m_ts
    python gdb.execute('continue') 
end

# breakpoint 5: 
b ipc/msg.c:1151
condition 5 (*msg).m_ts == $fake_size
commands
    silent
    printf "leaked seq_operations: %p", *(struct seq_operations *)(msg.next+4) 
    python gdb.execute('continue') 
end

# breakpoint 6:
b *legacy_parse_param+337
condition 6 (*(unsigned int *)($rbp-0x30)) == 0xfff && (*(char *)$rsi == 0x43)

# breakpoint 7:
break ipc/msgutil.c:99
condition 7 msg->m_ts == 0x4343434343434343

disable 3

disable 5

target remote localhost:1234

continue
